pipeline {
    agent {
        label 'jenkins-agent'
    }
    
    tools {
        maven 'maven-3.9.10'
    }
    
    environment {
        AWS_ACCOUNT_ID = '319998871902'
        AWS_REGION = 'us-east-1'
        ECR_REPO = "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/user-management"
        CLUSTER_NAME = 'comic-website-prod'
        KUBE_NAMESPACE = 'user-management'
        DOCKER_IMAGE = "${ECR_REPO}:${env.BUILD_NUMBER}"
        APP_NAME = "user-management-system"
        VPC_NAME = "comic-website-prod-vpc"  
    }
    
    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timeout(time: 45, unit: 'MINUTES')
        disableConcurrentBuilds()
    }
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
                sh '''
                    echo "=== ä»£ç ä¿¡æ¯ ==="
                    echo "ä»“åº“: ${GIT_URL}"
                    echo "åˆ†æ”¯: ${GIT_BRANCH}"
                    echo "Commit: ${GIT_COMMIT}"
                    git log -1 --oneline
                '''
            }
        }
        
        stage('Build Application') {
            steps {
                sh '''
                    echo "=== å¼€å§‹æ„å»ºåº”ç”¨ ==="
                    echo "Maven ç‰ˆæœ¬:"
                    mvn --version
                    mvn clean package -DskipTests=true
                    echo "æ„å»ºå®Œæˆ!"
                '''
            }
        }
        
        stage('Docker Build') {
            steps {
                script {
                    echo "=== æ„å»º Docker é•œåƒ ==="
                    sh 'docker --version'
                    docker.build("${DOCKER_IMAGE}")
                }
            }
        }
        
        stage('Docker Push to ECR') {
            steps {
                script {
                    withCredentials([[
                        $class: 'AmazonWebServicesCredentialsBinding',
                        credentialsId: 'dev-user-aws-credentials',
                        accessKeyVariable: 'AWS_ACCESS_KEY_ID',
                        secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
                    ]]) {
                        sh """
                            echo "=== æ¨é€é•œåƒåˆ° ECR ==="
                            
                            # æ£€æŸ¥ ECR ä»“åº“æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»º
                            if ! aws ecr describe-repositories --repository-names user-management --region ${AWS_REGION} > /dev/null 2>&1; then
                                echo "åˆ›å»º ECR ä»“åº“..."
                                aws ecr create-repository --repository-name user-management --region ${AWS_REGION}
                            fi
                            
                            # ç™»å½• ECR
                            aws ecr get-login-password --region ${AWS_REGION} | \
                            docker login --username AWS --password-stdin ${ECR_REPO}
                            
                            # æ¨é€æ„å»ºç‰ˆæœ¬
                            echo "æ¨é€é•œåƒ: ${DOCKER_IMAGE}"
                            docker push ${DOCKER_IMAGE}
                            
                            # æ¨é€ latest æ ‡ç­¾
                            echo "æ¨é€ latest æ ‡ç­¾"
                            docker tag ${DOCKER_IMAGE} ${ECR_REPO}:latest
                            docker push ${ECR_REPO}:latest
                            
                            echo "é•œåƒæ¨é€å®Œæˆ!"
                        """
                    }
                }
            }
        }
        
        stage('Deploy to EKS') {
            steps {
                script {
                    withCredentials([[
                        $class: 'AmazonWebServicesCredentialsBinding',
                        credentialsId: 'dev-user-aws-credentials',
                        accessKeyVariable: 'AWS_ACCESS_KEY_ID',
                        secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
                    ]]) {
                        sh """
                            echo "=== éƒ¨ç½²åº”ç”¨åˆ° EKS ==="
                            
                            # é…ç½® kubeconfig
                            aws eks update-kubeconfig \
                                --region ${AWS_REGION} \
                                --name ${CLUSTER_NAME}
                            
                            echo "å½“å‰é›†ç¾¤:"
                            kubectl config current-context
                        """
                        
                        // éƒ¨ç½²å‘½åç©ºé—´
                        sh """
                            kubectl apply -f k8s/namespace.yaml
                        """
                        
                        // éƒ¨ç½²æ•°æ®åº“
                        sh """
                            echo "éƒ¨ç½²æ•°æ®åº“..."
                            kubectl apply -f k8s/database/ -n ${KUBE_NAMESPACE}
                            
                            # ç­‰å¾…æ•°æ®åº“å°±ç»ª
                            echo "ç­‰å¾…æ•°æ®åº“å¯åŠ¨..."
                            sleep 60
                        """
                        
                        // éƒ¨ç½²åº”ç”¨
                        sh """
                            echo "éƒ¨ç½²åº”ç”¨..."
                            kubectl apply -f k8s/application/ -n ${KUBE_NAMESPACE}
                        """
                        
                        // éƒ¨ç½² NLB Service
                        sh """
                            echo "éƒ¨ç½² NLB Service..."
                            kubectl apply -f k8s/networking/nlb-service.yaml -n ${KUBE_NAMESPACE}
                            
                            # ç­‰å¾… NLB åˆ›å»º
                            echo "ç­‰å¾… NLB åˆ›å»º..."
                            sleep 30
                        """
                        
                        // æ›´æ–°é•œåƒ
                        sh """
                            echo "æ›´æ–°åº”ç”¨é•œåƒ..."
                            kubectl set image deployment/user-management-app \
                                user-management-app=${DOCKER_IMAGE} \
                                -n ${KUBE_NAMESPACE}
                        """
                        
                        // ç­‰å¾…éƒ¨ç½²å®Œæˆ
                        sh """
                            echo "ç­‰å¾…éƒ¨ç½²å®Œæˆ..."
                            kubectl rollout status deployment/user-management-app \
                                -n ${KUBE_NAMESPACE} --timeout=600s
                        """
                        
                        // è·å– NLB DNS åç§°
                        sh """
                            echo "è·å– NLB DNS åç§°..."
                            NLB_DNS=\$(kubectl get service user-management-nlb -n ${KUBE_NAMESPACE} -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
                            echo "ğŸ¯ NLB DNS: \$NLB_DNS"
                        """
                        
                        // æ˜¾ç¤ºéƒ¨ç½²çŠ¶æ€
                        sh """
                            echo "=== éƒ¨ç½²çŠ¶æ€ ==="
                            echo "Pods:"
                            kubectl get pods -n ${KUBE_NAMESPACE} -o wide
                            echo ""
                            echo "Services:"
                            kubectl get service -n ${KUBE_NAMESPACE}
                            echo ""
                            echo "NLB Service çŠ¶æ€:"
                            kubectl get svc user-management-nlb -n ${KUBE_NAMESPACE} -o wide
                            echo ""
                            echo "ğŸ’¡ æ¶æ„: ç”¨æˆ· â†’ NLB â†’ EKS Pods"
                        """
                    }
                }
            }
        }
        
        stage('Health Check') {
            steps {
                script {
                    echo "=== å¥åº·æ£€æŸ¥ ==="
                    
                    // é€šè¿‡ NLB è¿›è¡Œå¥åº·æ£€æŸ¥
                    sh """
                        echo "é€šè¿‡ NLB è¿›è¡Œå¥åº·æ£€æŸ¥..."
                        NLB_DNS=\$(kubectl get service user-management-nlb -n ${KUBE_NAMESPACE} -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
                        echo "NLB DNS: \$NLB_DNS"
                        
                        if [ ! -z "\$NLB_DNS" ]; then
                            echo "ç­‰å¾… NLB å®Œå…¨å°±ç»ª..."
                            sleep 30
                            
                            echo "æµ‹è¯•å¥åº·æ£€æŸ¥ç«¯ç‚¹..."
                            curl -s http://\$NLB_DNS/api/health || echo "å¥åº·æ£€æŸ¥è¯·æ±‚å¤±è´¥"
                        else
                            echo "æœªè·å–åˆ° NLB DNSï¼Œè·³è¿‡å¥åº·æ£€æŸ¥"
                        fi
                    """
                }
            }
        }
    }
    
    post {
        always {
            script {
                cleanWs()
                currentBuild.description = "Build ${env.BUILD_NUMBER}"
                
                echo "=========================================="
                echo "æ„å»ºç»“æœ: ${currentBuild.result}"
                echo "æ„å»ºå·: ${env.BUILD_NUMBER}"
                echo "=========================================="
            }
        }
        success {
            script {
                echo "ğŸ‰ éƒ¨ç½²æˆåŠŸ!"
                echo "ğŸ“¦ åº”ç”¨å·²éƒ¨ç½²åˆ° EKS"
                echo "ğŸŒ é€šè¿‡ NLB è®¿é—®åº”ç”¨"
                
                sh """
                    NLB_DNS=\$(kubectl get service user-management-nlb -n ${KUBE_NAMESPACE} -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || echo "")
                    if [ ! -z "\$NLB_DNS" ]; then
                        echo "ğŸ”— NLB åœ°å€: http://\$NLB_DNS"
                        echo "â¤ï¸  å¥åº·æ£€æŸ¥: http://\$NLB_DNS/api/health"
                        echo "ğŸ‘¥ ç”¨æˆ·ç®¡ç†: http://\$NLB_DNS/api/users"
                        echo "ğŸ“š APIæ–‡æ¡£: http://\$NLB_DNS/swagger-ui.html"
                    fi
                """
            }
        }
        failure {
            script {
                echo "âŒ éƒ¨ç½²å¤±è´¥!"
                echo "ğŸ” è¯¦ç»†æ—¥å¿—: ${env.BUILD_URL}console"
                
                // æ˜¾ç¤ºé”™è¯¯è¯Šæ–­ä¿¡æ¯
                sh """
                    echo "=== é”™è¯¯è¯Šæ–­ ==="
                    echo "Pod çŠ¶æ€:"
                    kubectl get pods -n ${KUBE_NAMESPACE} || true
                    echo ""
                    echo "Service çŠ¶æ€:"
                    kubectl get service -n ${KUBE_NAMESPACE} || true
                    echo ""
                    echo "æœ€è¿‘çš„äº‹ä»¶:"
                    kubectl get events -n ${KUBE_NAMESPACE} --sort-by='.lastTimestamp' | tail -10 || true
                """
            }
        }
    }
}